# =========================================================
# SFDA ProDe 风格实验 - 默认配置
# =========================================================
# 此文件包含所有默认配置项
# 实验时创建单独的配置文件（如 art2clipart_prode.yaml）覆盖需要修改的项
# 用法: python main.py -c configs/art2clipart_prode.yaml
# =========================================================

# ============== 数据配置 ==============
data:
  root: "data/officehome"
  source: "Art"                    # 源域: Art, Clipart, Product, RealWorld
  target: "Clipart"                # 目标域
  num_classes: 65
  num_workers: 4
  image_size: 224
  # 类别名称（用于 CLIP prompt）
  classnames: null                 # null 则使用数字，可设为类名列表

# ============== 模型配置 ==============
model:
  backbone: "resnet50"             # resnet50, resnet101
  pretrained: true                 # 使用ImageNet预训练
  bottleneck_dim: 256              # Bottleneck特征维度
  dropout: 0.5

# ============== 训练配置 ==============
train:
  # 源域训练
  source:
    epochs: 15
    batch_size: 64
    lr: 0.01
    lr_backbone: 0.001             # backbone学习率（较小）
    label_smooth_epsilon: 0.1      # 标签平滑参数

  # 目标域适应 (ProDe 风格)
  target:
    epochs: 30                     # ProDe 默认 30 epochs
    batch_size: 64
    lr: 0.005                      # ProDe 默认 5e-3
    lr_backbone: 0.0005
    momentum: 0.9
    weight_decay: 0.001
    
    # ProDe 核心超参数
    prode:
      gent_par: 0.4                # CE Loss 权重
      iic_par: 1.3                 # IIC Loss 权重
      div_weight: 1.0              # Diversity Loss 权重
      epsilon: 1.0e-5              # 数值稳定
      tta_steps: 1                 # TTA 步数
      logits_bank_decay: 1.0       # 与原版 ProDe 一致
      
      # CLIP 配置
      clip:
        arch: "ViT-B/32"           # CLIP 架构 (OpenAI 格式)
        n_ctx: 4                   # Context token 数量
        ctx_init: "a_photo_of_a"   # Prompt 初始化
        lr_decay: 0.1              # CLIP prompt 学习率衰减
      
      # 三方一致性
      consensus_conf_threshold: 0.7  # 单样本 softmax 置信度阈值
      noise_std: 0.1                # 高斯扰动标准差
      
      # KNN 标签修正
      knn_k: 7                      # 近邻数（奇数避免平票）
      
      # Mixup
      mixup_alpha: 0.8              # Beta 分布参数
      mixup_weight: 0.3             # Mixup CE loss 权重
      mixup_label_bias: 0.7         # 标签偏向高可信的最小权重
      
      # CLIP 文本锚点
      anchor_weight: 0.1            # 锚点对齐 loss 权重
      projector_hidden_dim: 384     # 投影层隐藏维度
      
      # 可视化
      vis_interval: 5               # 每多少个 epoch 画图

  # Adapter-based 目标域适应 (保留备用)
  adapter:
    epochs: 15
    batch_size: 32
    lr: 0.001
    weight_decay: 0.0001
    hidden_dim: 512
    num_layers: 2
    dropout: 0.1
    align_weight: 1.0
    div_weight: 0.1
    ent_weight: 0.1
    huber_delta: 1.0
    confidence_threshold: 0.7
    use_dynamic_prototype: true
    prototype_momentum: 0.9

# ============== 设备配置 ==============
device:
  type: "cuda"                      # cuda, mps, cpu
  gpu_id: 0                        # 仅cuda时使用

# ============== 日志配置 ==============
logging:
  log_dir: "logs"
  log_interval: 10                 # 每多少个batch输出一次
  save_interval: 5                 # 每多少个epoch保存一次

# ============== 保存配置 ==============
checkpoint:
  save_dir: "checkpoints"
  save_best: true

# ============== 随机种子 ==============
seed: 2024
